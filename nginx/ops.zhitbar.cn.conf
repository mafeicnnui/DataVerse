# Nginx site config for ops.zhitbar.cn
# 前端构建目录：/opt/DataVerse/frontend/dist
# 后端 API：反向代理到本机 8001（示例，可按需调整）

# 1) HTTP -> HTTPS 强制跳转
server {
    listen 80;
    listen [::]:80;
    server_name ops.zhitbar.cn;

    # ACME 验证目录（certbot --nginx 会自动接管，也保留 webroot 方式）
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 首次申请证书前可用 HTTP 访问静态资源
    location / {
        return 301 https://$host$request_uri;
    }
}

# 2) HTTPS 站点
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name ops.zhitbar.cn;

    # 证书路径（执行 certbot 后会自动写入/更新）
    ssl_certificate     /etc/letsencrypt/live/ops.zhitbar.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ops.zhitbar.cn/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 上传大小限制（适配 SFTP/文件上传）
    client_max_body_size 200m;

    # 前端静态资源
    root /opt/DataVerse/frontend/dist;
    index index.html;

    # 前端路由（SPA）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 反向代理 API
    location /api/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        client_max_body_size 200m;
    }

    # 访问日志（可按需开启/关闭）
    access_log /var/log/nginx/ops.zhitbar.cn.access.log;
    error_log  /var/log/nginx/ops.zhitbar.cn.error.log warn;
}

# 使用说明：
# 1) 首次部署前创建 webroot（仅 webroot 模式需要）：
#    mkdir -p /var/www/certbot
#    chown -R nginx:nginx /var/www/certbot   # 或 www-data 视发行版而定
#
# 2) 申请/续期证书（推荐 --nginx 方式，自动写入 ssl_* 配置）：
#    certbot --nginx -d ops.zhitbar.cn --email your@email.com --agree-tos --no-eff-email
#
#    或使用 webroot 模式（不会改 nginx 配置）：
#    certbot certonly --webroot -w /var/www/certbot -d ops.zhitbar.cn --email your@email.com --agree-tos --no-eff-email
#
# 3) 自动续期：certbot 自带 systemd timer；可手动测试：
#    certbot renew --dry-run
